{
  "version": 4,
  "terraform_version": "1.14.5",
  "serial": 47,
  "lineage": "29986bfa-b877-e3f9-6271-a843b3f428bc",
  "outputs": {
    "build_log_info": {
      "value": "Azure Portal \u003e Image Templates \u003e aib-w365-dev-ai-1-0-2 \u003e Logs (or run: Get-AzImageBuilderTemplate -Name 'aib-w365-dev-ai-1-0-2' -ResourceGroupName 'rg-w365-images' | Select-Object -ExpandProperty LastRunStatus)",
      "type": "string"
    },
    "gallery_id": {
      "value": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Compute/galleries/acgW365Dev",
      "type": "string"
    },
    "image_definition_id": {
      "value": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Compute/galleries/acgW365Dev/images/W365-W11-25H2-ENU",
      "type": "string"
    },
    "image_template_name": {
      "value": "aib-w365-dev-ai-1-0-2",
      "type": "string"
    },
    "managed_identity_id": {
      "value": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.ManagedIdentity/userAssignedIdentities/id-aib-w365-dev",
      "type": "string"
    },
    "managed_identity_principal_id": {
      "value": "8e8bff56-b7ab-4d1d-a6fb-4d82ed2983fa",
      "type": "string"
    },
    "next_steps": {
      "value": "\n══════════════════════════════════════════════════════════════════\nIMAGE BUILD COMPLETE — NEXT STEPS\n══════════════════════════════════════════════════════════════════\n\n1. VERIFY IMAGE VERSION\n   Get-AzGalleryImageVersion `\n     -ResourceGroupName \"rg-w365-images\" `\n     -GalleryName \"acgW365Dev\" `\n     -GalleryImageDefinitionName \"W365-W11-25H2-ENU\" |\n     Format-Table Name, ProvisioningState, PublishingProfile\n\n2. TEAR DOWN BUILD INFRASTRUCTURE (cost optimization)\n   Remove the AIB template and build resources (gallery is protected):\n   .\\scripts\\Teardown-BuildResources.ps1\n\n   NOTE: Do NOT run 'terraform destroy' — the gallery and image\n   definition have prevent_destroy = true and destroy will fail.\n\n3. IMPORT INTO WINDOWS 365 (Portal)\n   Intune \u003e Devices \u003e Windows 365 \u003e Custom images \u003e Add\n   \u003e Azure Compute Gallery\n   \u003e Select: acgW365Dev / W365-W11-25H2-ENU / 1.0.2\n\n4. CREATE/UPDATE PROVISIONING POLICY\n   Assign the imported image to a provisioning policy\n   targeting your developer security group.\n\n5. USER CONFIGURATION (post-login)\n   Each user manages their own ANTHROPIC_API_KEY:\n   - Set as user environment variable, or\n   - Configure via OpenClaw settings\n\n6. PROMOTE (when validated)\n   Set exclude_from_latest = false and re-apply:\n   terraform apply -var='exclude_from_latest=false'\n\n══════════════════════════════════════════════════════════════════\n",
      "type": "string"
    }
  },
  "resources": [
    {
      "mode": "managed",
      "type": "azurerm_resource_group",
      "name": "images",
      "provider": "provider[\"registry.terraform.io/hashicorp/azurerm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images",
            "location": "eastus2",
            "managed_by": "",
            "name": "rg-w365-images",
            "tags": {
              "cost_center": "Engineering",
              "iac": "Terraform",
              "managed_by": "PlatformEngineering",
              "purpose": "DeveloperImages",
              "workload": "Windows365"
            },
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "identity": {
            "name": "rg-w365-images",
            "subscription_id": "7a713a84-2144-4ea1-8e85-9c63111bd995"
          },
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo1NDAwMDAwMDAwMDAwLCJkZWxldGUiOjU0MDAwMDAwMDAwMDAsInJlYWQiOjMwMDAwMDAwMDAwMCwidXBkYXRlIjo1NDAwMDAwMDAwMDAwfX0="
        }
      ]
    },
    {
      "module": "module.gallery",
      "mode": "managed",
      "type": "azurerm_shared_image",
      "name": "this",
      "provider": "provider[\"registry.terraform.io/hashicorp/azurerm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "accelerated_network_support_enabled": true,
            "architecture": "x64",
            "confidential_vm_enabled": false,
            "confidential_vm_supported": false,
            "description": "",
            "disk_controller_type_nvme_enabled": true,
            "disk_types_not_allowed": [],
            "end_of_life_date": null,
            "eula": "",
            "gallery_name": "acgW365Dev",
            "hibernation_enabled": true,
            "hyper_v_generation": "V2",
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Compute/galleries/acgW365Dev/images/W365-W11-25H2-ENU",
            "identifier": [
              {
                "offer": "W365-W11-25H2-ENU",
                "publisher": "BigHatGroupInc",
                "sku": "W11-25H2-ENT-Dev"
              }
            ],
            "location": "eastus2",
            "max_recommended_memory_in_gb": 0,
            "max_recommended_vcpu_count": 0,
            "min_recommended_memory_in_gb": 0,
            "min_recommended_vcpu_count": 0,
            "name": "W365-W11-25H2-ENU",
            "os_type": "Windows",
            "privacy_statement_uri": "",
            "purchase_plan": [],
            "release_note_uri": "",
            "resource_group_name": "rg-w365-images",
            "specialized": false,
            "tags": {
              "cost_center": "Engineering",
              "iac": "Terraform",
              "managed_by": "PlatformEngineering",
              "purpose": "DeveloperImages",
              "workload": "Windows365"
            },
            "timeouts": null,
            "trusted_launch_enabled": true,
            "trusted_launch_supported": false
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "identity": {
            "gallery_name": "acgW365Dev",
            "name": "W365-W11-25H2-ENU",
            "resource_group_name": "rg-w365-images",
            "subscription_id": "7a713a84-2144-4ea1-8e85-9c63111bd995"
          },
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInJlYWQiOjMwMDAwMDAwMDAwMCwidXBkYXRlIjoxODAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "azurerm_resource_group.images",
            "module.gallery.azurerm_shared_image_gallery.this"
          ]
        }
      ]
    },
    {
      "module": "module.gallery",
      "mode": "managed",
      "type": "azurerm_shared_image_gallery",
      "name": "this",
      "provider": "provider[\"registry.terraform.io/hashicorp/azurerm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "description": "",
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Compute/galleries/acgW365Dev",
            "location": "eastus2",
            "name": "acgW365Dev",
            "resource_group_name": "rg-w365-images",
            "sharing": [],
            "tags": {
              "cost_center": "Engineering",
              "iac": "Terraform",
              "managed_by": "PlatformEngineering",
              "purpose": "DeveloperImages",
              "workload": "Windows365"
            },
            "timeouts": null,
            "unique_name": "7a713a84-2144-4ea1-8e85-9c63111bd995-ACGW365DEV"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "identity": {
            "name": "acgW365Dev",
            "resource_group_name": "rg-w365-images",
            "subscription_id": "7a713a84-2144-4ea1-8e85-9c63111bd995"
          },
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInJlYWQiOjMwMDAwMDAwMDAwMCwidXBkYXRlIjoxODAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "azurerm_resource_group.images"
          ]
        }
      ]
    },
    {
      "module": "module.identity",
      "mode": "managed",
      "type": "azurerm_role_assignment",
      "name": "aib_gallery_contributor",
      "provider": "provider[\"registry.terraform.io/hashicorp/azurerm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "condition": "",
            "condition_version": "",
            "delegated_managed_identity_resource_id": "",
            "description": "",
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Compute/galleries/acgW365Dev/providers/Microsoft.Authorization/roleAssignments/08833943-1b53-a5cd-898e-558a1bdae76b",
            "name": "08833943-1b53-a5cd-898e-558a1bdae76b",
            "principal_id": "8e8bff56-b7ab-4d1d-a6fb-4d82ed2983fa",
            "principal_type": "ServicePrincipal",
            "role_definition_id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/providers/Microsoft.Authorization/roleDefinitions/85a2d0d9-2eba-4c9c-b355-11c2cc0788ab",
            "role_definition_name": "Compute Gallery Artifacts Publisher",
            "scope": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Compute/galleries/acgW365Dev",
            "skip_service_principal_aad_check": true,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInJlYWQiOjMwMDAwMDAwMDAwMH19",
          "dependencies": [
            "azurerm_resource_group.images",
            "module.gallery.azurerm_shared_image_gallery.this",
            "module.identity.azurerm_user_assigned_identity.aib"
          ]
        }
      ]
    },
    {
      "module": "module.identity",
      "mode": "managed",
      "type": "azurerm_role_assignment",
      "name": "aib_identity_operator",
      "provider": "provider[\"registry.terraform.io/hashicorp/azurerm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "condition": "",
            "condition_version": "",
            "delegated_managed_identity_resource_id": "",
            "description": "",
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Authorization/roleAssignments/db154f76-96f9-bc9f-f512-dfddddf7a161",
            "name": "db154f76-96f9-bc9f-f512-dfddddf7a161",
            "principal_id": "8e8bff56-b7ab-4d1d-a6fb-4d82ed2983fa",
            "principal_type": "ServicePrincipal",
            "role_definition_id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/providers/Microsoft.Authorization/roleDefinitions/f1a07417-d97a-45cb-824c-7a7467783830",
            "role_definition_name": "Managed Identity Operator",
            "scope": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images",
            "skip_service_principal_aad_check": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "bnVsbA==",
          "dependencies": [
            "azurerm_resource_group.images",
            "module.identity.azurerm_user_assigned_identity.aib"
          ]
        }
      ]
    },
    {
      "module": "module.identity",
      "mode": "managed",
      "type": "azurerm_role_assignment",
      "name": "aib_network_contributor",
      "provider": "provider[\"registry.terraform.io/hashicorp/azurerm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "condition": "",
            "condition_version": "",
            "delegated_managed_identity_resource_id": "",
            "description": "",
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Authorization/roleAssignments/dda7dae9-8c13-4307-0e18-c07dc64ebad9",
            "name": "dda7dae9-8c13-4307-0e18-c07dc64ebad9",
            "principal_id": "8e8bff56-b7ab-4d1d-a6fb-4d82ed2983fa",
            "principal_type": "ServicePrincipal",
            "role_definition_id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7",
            "role_definition_name": "Network Contributor",
            "scope": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images",
            "skip_service_principal_aad_check": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "bnVsbA==",
          "dependencies": [
            "azurerm_resource_group.images",
            "module.identity.azurerm_user_assigned_identity.aib"
          ]
        }
      ]
    },
    {
      "module": "module.identity",
      "mode": "managed",
      "type": "azurerm_role_assignment",
      "name": "aib_vm_contributor",
      "provider": "provider[\"registry.terraform.io/hashicorp/azurerm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "condition": "",
            "condition_version": "",
            "delegated_managed_identity_resource_id": "",
            "description": "",
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Authorization/roleAssignments/995031af-14db-b3ed-e6f5-4f384a6a63da",
            "name": "995031af-14db-b3ed-e6f5-4f384a6a63da",
            "principal_id": "8e8bff56-b7ab-4d1d-a6fb-4d82ed2983fa",
            "principal_type": "ServicePrincipal",
            "role_definition_id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/providers/Microsoft.Authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
            "role_definition_name": "Virtual Machine Contributor",
            "scope": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images",
            "skip_service_principal_aad_check": null,
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "bnVsbA==",
          "dependencies": [
            "azurerm_resource_group.images",
            "module.identity.azurerm_user_assigned_identity.aib"
          ]
        }
      ]
    },
    {
      "module": "module.identity",
      "mode": "managed",
      "type": "azurerm_user_assigned_identity",
      "name": "aib",
      "provider": "provider[\"registry.terraform.io/hashicorp/azurerm\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "client_id": "9e46c2d2-a830-41f3-940d-fbaf1efec158",
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.ManagedIdentity/userAssignedIdentities/id-aib-w365-dev",
            "isolation_scope": "",
            "location": "eastus2",
            "name": "id-aib-w365-dev",
            "principal_id": "8e8bff56-b7ab-4d1d-a6fb-4d82ed2983fa",
            "resource_group_name": "rg-w365-images",
            "tags": {
              "cost_center": "Engineering",
              "iac": "Terraform",
              "managed_by": "PlatformEngineering",
              "purpose": "DeveloperImages",
              "workload": "Windows365"
            },
            "tenant_id": "5a01497e-1bcb-4711-b6e6-d24f4ab00393",
            "timeouts": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInJlYWQiOjMwMDAwMDAwMDAwMCwidXBkYXRlIjoxODAwMDAwMDAwMDAwfSwic2NoZW1hX3ZlcnNpb24iOiIxIn0=",
          "dependencies": [
            "azurerm_resource_group.images"
          ]
        }
      ]
    },
    {
      "module": "module.image_builder",
      "mode": "managed",
      "type": "azapi_resource",
      "name": "image_template",
      "provider": "provider[\"registry.terraform.io/azure/azapi\"]",
      "instances": [
        {
          "schema_version": 2,
          "attributes": {
            "body": {
              "value": {
                "properties": {
                  "buildTimeoutInMinutes": 120,
                  "customize": [
                    {
                      "inline": [
                        "$ErrorActionPreference = \"Stop\"\n$ProgressPreference = \"SilentlyContinue\"\n\nfunction Update-SessionEnvironment {\n    $machinePath = [Environment]::GetEnvironmentVariable(\"Path\", \"Machine\")\n    $userPath = [Environment]::GetEnvironmentVariable(\"Path\", \"User\")\n    $env:Path = \"$machinePath;$userPath\"\n    Write-Host \"[PATH] Session environment refreshed\"\n}\n\nfunction Get-InstallerWithRetry {\n    param([string]$Uri, [string]$OutFile, [int]$MaxRetries = 3)\n    for ($i = 1; $i -le $MaxRetries; $i++) {\n        try {\n            Write-Host \"[DOWNLOAD] Attempt $i of $MaxRetries : $Uri\"\n            Invoke-WebRequest -Uri $Uri -OutFile $OutFile -UseBasicParsing\n            return\n        } catch {\n            if ($i -eq $MaxRetries) { throw }\n            Write-Host \"[DOWNLOAD] Attempt $i failed, retrying in 10 seconds...\"\n            Start-Sleep -Seconds 10\n        }\n    }\n}\n\nfunction Test-InstallerHash {\n    param([string]$FilePath, [string]$ExpectedHash)\n    if ([string]::IsNullOrWhiteSpace($ExpectedHash)) {\n        Write-Host \"[INTEGRITY] No SHA256 provided for $(Split-Path $FilePath -Leaf) - skipping verification\"\n        return\n    }\n    $actual = (Get-FileHash -Path $FilePath -Algorithm SHA256).Hash\n    if ($actual -ne $ExpectedHash.ToUpper()) {\n        Write-Error \"[INTEGRITY] SHA256 MISMATCH for $(Split-Path $FilePath -Leaf)! Expected: $ExpectedHash Got: $actual\"\n        exit 1\n    }\n    Write-Host \"[INTEGRITY] SHA256 verified for $(Split-Path $FilePath -Leaf)\"\n}\n\n# === NODE.JS ===\n$NodeVersion = \"v24.13.1\"\n$NodeMsiUrl = \"https://nodejs.org/dist/$NodeVersion/node-$NodeVersion-x64.msi\"\n$NodeInstaller = \"$env:TEMP\\node-$NodeVersion-x64.msi\"\n\nWrite-Host \"=== Installing Node.js $NodeVersion ===\"\nGet-InstallerWithRetry -Uri $NodeMsiUrl -OutFile $NodeInstaller\nTest-InstallerHash -FilePath $NodeInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath \"msiexec.exe\" `\n    -ArgumentList \"/i `\"$NodeInstaller`\" /qn /norestart ALLUSERS=1 ADDLOCAL=ALL\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"Node.js installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] Node.js: $(node --version)\"\nWrite-Host \"[VERIFY] npm: $(npm --version)\"\n\n# === PYTHON ===\n$PythonVersion = \"3.14.3\"\n$PythonUrl = \"https://www.python.org/ftp/python/$PythonVersion/python-$PythonVersion-amd64.exe\"\n$PythonInstaller = \"$env:TEMP\\python-$PythonVersion-amd64.exe\"\n\nWrite-Host \"=== Installing Python $PythonVersion ===\"\nGet-InstallerWithRetry -Uri $PythonUrl -OutFile $PythonInstaller\nTest-InstallerHash -FilePath $PythonInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath $PythonInstaller `\n    -ArgumentList \"/quiet InstallAllUsers=1 PrependPath=1 Include_pip=1 Include_test=0 Include_launcher=1\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"Python installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] Python: $(python --version)\"\npython -m pip install --upgrade pip --quiet\nWrite-Host \"[VERIFY] pip: $(python -m pip --version)\"\n\n# === POWERSHELL 7 ===\nWrite-Host \"=== Installing PowerShell 7 ===\"\n$PwshVersion = \"7.4.13\"\n$PwshUrl = \"https://github.com/PowerShell/PowerShell/releases/download/v$PwshVersion/PowerShell-$PwshVersion-win-x64.msi\"\n$PwshInstaller = \"$env:TEMP\\PowerShell-7-x64.msi\"\nGet-InstallerWithRetry -Uri $PwshUrl -OutFile $PwshInstaller\nTest-InstallerHash -FilePath $PwshInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath \"msiexec.exe\" `\n    -ArgumentList \"/i `\"$PwshInstaller`\" /qn /norestart ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=1 ADD_FILE_CONTEXT_MENU_RUNPOWERSHELL=1 ENABLE_PSREMOTING=0 REGISTER_MANIFEST=1 USE_MU=0 ENABLE_MU=0 ADD_PATH=1\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"PowerShell 7 installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] PowerShell 7 installed\"\n\n# === CLEANUP ===\nRemove-Item -Path $NodeInstaller, $PythonInstaller, $PwshInstaller -Force -ErrorAction SilentlyContinue\nWrite-Host \"=== Phase 1 Complete: Runtimes installed ===\"\n"
                      ],
                      "name": "InstallCoreRuntimes",
                      "runAsSystem": true,
                      "runElevated": true,
                      "type": "PowerShell"
                    },
                    {
                      "restartCheckCommand": "powershell -command \"node --version; python --version\"",
                      "restartCommand": "shutdown /r /f /t 5 /c \"Restart after runtime installation\"",
                      "restartTimeout": "10m",
                      "type": "WindowsRestart"
                    },
                    {
                      "inline": [
                        "$ErrorActionPreference = \"Stop\"\n$ProgressPreference = \"SilentlyContinue\"\n\nfunction Update-SessionEnvironment {\n    $machinePath = [Environment]::GetEnvironmentVariable(\"Path\", \"Machine\")\n    $userPath = [Environment]::GetEnvironmentVariable(\"Path\", \"User\")\n    $env:Path = \"$machinePath;$userPath\"\n}\n\nfunction Get-InstallerWithRetry {\n    param([string]$Uri, [string]$OutFile, [int]$MaxRetries = 3)\n    for ($i = 1; $i -le $MaxRetries; $i++) {\n        try { Invoke-WebRequest -Uri $Uri -OutFile $OutFile -UseBasicParsing; return }\n        catch { if ($i -eq $MaxRetries) { throw }; Start-Sleep -Seconds 10 }\n    }\n}\n\nfunction Test-InstallerHash {\n    param([string]$FilePath, [string]$ExpectedHash)\n    if ([string]::IsNullOrWhiteSpace($ExpectedHash)) {\n        Write-Host \"[INTEGRITY] No SHA256 provided for $(Split-Path $FilePath -Leaf) - skipping verification\"\n        return\n    }\n    $actual = (Get-FileHash -Path $FilePath -Algorithm SHA256).Hash\n    if ($actual -ne $ExpectedHash.ToUpper()) {\n        Write-Error \"[INTEGRITY] SHA256 MISMATCH for $(Split-Path $FilePath -Leaf)! Expected: $ExpectedHash Got: $actual\"\n        exit 1\n    }\n    Write-Host \"[INTEGRITY] SHA256 verified for $(Split-Path $FilePath -Leaf)\"\n}\n\n# === VISUAL STUDIO CODE ===\nWrite-Host \"=== Installing Visual Studio Code (System) ===\"\n$VSCodeUrl = \"https://update.code.visualstudio.com/latest/win32-x64/stable\"\n$VSCodeInstaller = \"$env:TEMP\\VSCodeSetup-x64.exe\"\nGet-InstallerWithRetry -Uri $VSCodeUrl -OutFile $VSCodeInstaller\n\n$proc = Start-Process -FilePath $VSCodeInstaller `\n    -ArgumentList \"/VERYSILENT /NORESTART /MERGETASKS=`\"!runcode,addcontextmenufiles,addcontextmenufolders,addtopath`\"\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"VS Code installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] VS Code installed to: C:\\Program Files\\Microsoft VS Code\"\n\n# === GIT FOR WINDOWS ===\nWrite-Host \"=== Installing Git for Windows ===\"\n$GitVersion = \"2.53.0\"\n$GitUrl = \"https://github.com/git-for-windows/git/releases/download/v${GitVersion}.windows.1/Git-${GitVersion}-64-bit.exe\"\n$GitInstaller = \"$env:TEMP\\Git-${GitVersion}-64-bit.exe\"\nGet-InstallerWithRetry -Uri $GitUrl -OutFile $GitInstaller\nTest-InstallerHash -FilePath $GitInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath $GitInstaller `\n    -ArgumentList \"/VERYSILENT /NORESTART /PathOption=Cmd /NoAutoCrlf /SetupType=default\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"Git installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] Git: $(git --version)\"\n\n# === GITHUB DESKTOP ===\nWrite-Host \"=== Installing GitHub Desktop (Machine-Wide Provisioner) ===\"\n$GHDesktopUrl = \"https://central.github.com/deployments/desktop/desktop/latest/GitHubDesktopSetup-x64.msi\"\n$GHDesktopInstaller = \"$env:TEMP\\GitHubDesktop-x64.msi\"\nGet-InstallerWithRetry -Uri $GHDesktopUrl -OutFile $GHDesktopInstaller\n\n$proc = Start-Process -FilePath \"msiexec.exe\" `\n    -ArgumentList \"/i `\"$GHDesktopInstaller`\" /qn /norestart ALLUSERS=1\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"GitHub Desktop installation failed ($($proc.ExitCode))\"; exit 1 }\nWrite-Host \"[VERIFY] GitHub Desktop provisioner installed\"\n\n# === AZURE CLI ===\n$AzCliVersion = \"2.83.0\"\nWrite-Host \"=== Installing Azure CLI $AzCliVersion ===\"\n$AzCliUrl = \"https://azcliprod.blob.core.windows.net/msi/azure-cli-$AzCliVersion-x64.msi\"\n$AzCliInstaller = \"$env:TEMP\\azure-cli-$AzCliVersion-x64.msi\"\nGet-InstallerWithRetry -Uri $AzCliUrl -OutFile $AzCliInstaller\nTest-InstallerHash -FilePath $AzCliInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath \"msiexec.exe\" `\n    -ArgumentList \"/i `\"$AzCliInstaller`\" /qn /norestart ALLUSERS=1\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"Azure CLI installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] Azure CLI: $(az --version 2\u003e\u00261 | Select-Object -First 1)\"\n\n# === GITHUB COPILOT (VS Code Extension) ===\nWrite-Host \"=== Installing GitHub Copilot VS Code Extension ===\"\n$codeBin = \"C:\\Program Files\\Microsoft VS Code\\bin\\code.cmd\"\nif (Test-Path $codeBin) {\n    \u0026 $codeBin --install-extension GitHub.copilot --force 2\u003e\u00261 | Write-Host\n    \u0026 $codeBin --install-extension GitHub.copilot-chat --force 2\u003e\u00261 | Write-Host\n    Write-Host \"[VERIFY] GitHub Copilot extensions installed\"\n} else {\n    Write-Error \"VS Code not found at expected path - cannot install Copilot extension\"\n    exit 1\n}\n\n# === CLEANUP ===\nRemove-Item -Path $VSCodeInstaller, $GitInstaller, $GHDesktopInstaller, $AzCliInstaller -Force -ErrorAction SilentlyContinue\nWrite-Host \"=== Phase 2 Complete: Developer tools installed ===\"\n"
                      ],
                      "name": "InstallDevTools",
                      "runAsSystem": true,
                      "runElevated": true,
                      "type": "PowerShell"
                    },
                    {
                      "inline": [
                        "$ErrorActionPreference = \"Stop\"\n$ProgressPreference = \"SilentlyContinue\"\n\nfunction Update-SessionEnvironment {\n    $machinePath = [Environment]::GetEnvironmentVariable(\"Path\", \"Machine\")\n    $userPath = [Environment]::GetEnvironmentVariable(\"Path\", \"User\")\n    $env:Path = \"$machinePath;$userPath\"\n}\n\nUpdate-SessionEnvironment\n\n# Verify prerequisites\n$nodeCheck = Get-Command node -ErrorAction SilentlyContinue\n$npmCheck = Get-Command npm -ErrorAction SilentlyContinue\nif (-not $nodeCheck -or -not $npmCheck) {\n    Write-Error \"Node.js or npm not found in PATH. Phase 1 may have failed.\"\n    exit 1\n}\nWrite-Host \"[PREREQ] Node.js: $(node --version)\"\nWrite-Host \"[PREREQ] npm: $(npm --version)\"\n\n# === OPENSPEC ===\nWrite-Host \"=== Installing OpenSpec 0.9.1 (global) ===\"\nnpm install -g @fission-ai/openspec@0.9.1 2\u003e\u00261 | Write-Host\nif ($LASTEXITCODE -ne 0) { Write-Error \"OpenSpec npm install failed ($LASTEXITCODE)\"; exit 1 }\nUpdate-SessionEnvironment\n\n$openspecCheck = Get-Command openspec -ErrorAction SilentlyContinue\nif (-not $openspecCheck) { Write-Error \"openspec not found in PATH after installation\"; exit 1 }\nWrite-Host \"[VERIFY] OpenSpec: $(openspec --version 2\u003e\u00261)\"\n\n# === MCP SERVER PACKAGES ===\n$mcpPackages = @(\"@perplexity-ai/mcp-server\")\nif ($mcpPackages.Count -gt 0) {\n    Write-Host \"=== Installing MCP server packages ===\"\n    foreach ($pkg in $mcpPackages) {\n        Write-Host \"  Installing: $pkg\"\n        npm install -g $pkg 2\u003e\u00261 | Write-Host\n        if ($LASTEXITCODE -ne 0) {\n            Write-Warning \"MCP package install failed for $pkg (non-fatal)\"\n        }\n    }\n    Write-Host \"[VERIFY] MCP server packages installed: $($mcpPackages.Count)\"\n} else {\n    Write-Host \"[SKIP] No MCP server packages configured\"\n}\n\n# === NPM GLOBAL PACKAGE INVENTORY ===\nWrite-Host \"=== Listing global npm packages ===\"\nnpm list -g --depth=0 2\u003e\u00261 | Write-Host\nWrite-Host \"[SECURITY] Global package inventory logged (npm audit does not support --global)\"\n\n# === SBOM GENERATION ===\nWrite-Host \"=== Generating Software Bill of Materials (SBOM) ===\"\n$sbomDir = \"C:\\ProgramData\\ImageBuild\"\nNew-Item -ItemType Directory -Path $sbomDir -Force | Out-Null\n\n$globalPackages = npm list -g --json 2\u003e$null\nSet-Content -Path \"$sbomDir\\sbom-npm-global.json\" -Value $globalPackages -Encoding UTF8\nWrite-Host \"[SBOM] npm global packages: $sbomDir\\sbom-npm-global.json\"\n\n# Record installed software versions\n$softwareManifest = @{\n    buildDate       = (Get-Date -Format \"yyyy-MM-dd'T'HH:mm:ss'Z'\")\n    nodeVersion     = (node --version 2\u003e\u00261).ToString()\n    npmVersion      = (npm --version 2\u003e\u00261).ToString()\n    pythonVersion   = (python --version 2\u003e\u00261).ToString()\n    gitVersion      = (git --version 2\u003e\u00261).ToString()\n    pwshVersion     = (pwsh --version 2\u003e\u00261).ToString()\n    azCliVersion    = (az --version 2\u003e\u00261 | Select-Object -First 1).ToString()\n    openspecVersion = (openspec --version 2\u003e\u00261).ToString()\n} | ConvertTo-Json -Depth 3\nSet-Content -Path \"$sbomDir\\sbom-software-manifest.json\" -Value $softwareManifest -Encoding UTF8\nWrite-Host \"[SBOM] Software manifest: $sbomDir\\sbom-software-manifest.json\"\n\nWrite-Host \"=== Phase 3 Complete: AI tooling installed ===\"\n"
                      ],
                      "name": "InstallAIAgents",
                      "runAsSystem": true,
                      "runElevated": true,
                      "type": "PowerShell"
                    },
                    {
                      "inline": [
                        "        $ErrorActionPreference = \"Stop\"\n\n        # === CLAUDE CODE: Enterprise Managed Settings ===\n        Write-Host \"=== Configuring Claude Code enterprise policy ===\"\n        $claudeConfigDir = \"C:\\ProgramData\\ClaudeCode\"\n        New-Item -ItemType Directory -Path $claudeConfigDir -Force | Out-Null\n\n        $managedSettings = @{\n            autoUpdatesChannel = \"stable\"\n            permissions = @{\n                defaultMode = \"allowWithPermission\"\n            }\n        } | ConvertTo-Json -Depth 5\n\n        $managedSettingsPath = \"$claudeConfigDir\\managed-settings.json\"\n        Set-Content -Path $managedSettingsPath -Value $managedSettings -Encoding UTF8\n        Write-Host \"[CONFIG] Claude Code managed settings: $managedSettingsPath\"\n\n        # === OPENCLAW: Configuration Template ===\n        Write-Host \"=== Creating OpenClaw configuration template ===\"\n        $openclawTemplateDir = \"C:\\ProgramData\\OpenClaw\"\n        New-Item -ItemType Directory -Path $openclawTemplateDir -Force | Out-Null\n\n        $openclawConfig = @{\n            agent = @{\n                model = \"anthropic/claude-opus-4-6\"\n                defaults = @{\n                    workspace = \"~/Documents/OpenClawWorkspace\"\n                }\n            }\n            gateway = @{\n                mode = \"local\"\n                port = 18789\n            }\n            channels = @{\n                web = @{ enabled = $true }\n            }\n        } | ConvertTo-Json -Depth 5\n\n        $templatePath = \"$openclawTemplateDir\\template-config.json\"\n        Set-Content -Path $templatePath -Value $openclawConfig -Encoding UTF8\n        Write-Host \"[CONFIG] OpenClaw template: $templatePath\"\n\n        # === CURATED AGENT SKILLS ===\n        $skillsRepoUrl = \"\"\n        $skillsDir = \"C:\\ProgramData\\OpenClaw\\skills\"\n        if ($skillsRepoUrl -ne \"\") {\n            Write-Host \"=== Cloning curated agent skills ===\"\n            New-Item -ItemType Directory -Path $skillsDir -Force | Out-Null\n            git clone --depth 1 $skillsRepoUrl \"$skillsDir\\approved\" 2\u003e\u00261 | Write-Host\n            if ($LASTEXITCODE -ne 0) {\n                Write-Warning \"Skills clone failed - skills will need to be installed post-provisioning\"\n            } else {\n                $skillCount = (Get-ChildItem -Path \"$skillsDir\\approved\" -Filter \"SKILL.md\" -Recurse).Count\n                Write-Host \"[CONFIG] Curated skills cloned: $skillCount skills found\"\n            }\n        } else {\n            Write-Host \"[SKIP] No skills repository configured\"\n        }\n\n        # === MCP SERVER CONFIGURATION TEMPLATE ===\n        Write-Host \"=== Creating MCP server configuration template ===\"\n        $mcpConfigDir = \"C:\\ProgramData\\OpenClaw\\mcp\"\n        New-Item -ItemType Directory -Path $mcpConfigDir -Force | Out-Null\n\n        # Template with placeholder API keys - real keys delivered via Intune env vars\n        $mcpConfig = @{\n            servers = @{\n                \"microsoft-docs\" = @{\n                    transport = \"http\"\n                    url       = \"https://learn.microsoft.com/api/mcp\"\n                }\n                \"perplexity\" = @{\n                    transport = \"stdio\"\n                    command   = \"npx\"\n                    args      = @(\"-y\", \"@perplexity-ai/mcp-server\")\n                    env       = @{\n                        PERPLEXITY_API_KEY = \"__PERPLEXITY_API_KEY__\"\n                    }\n                }\n            }\n        } | ConvertTo-Json -Depth 5\n\n        Set-Content -Path \"$mcpConfigDir\\mcporter.json\" -Value $mcpConfig -Encoding UTF8\n        Write-Host \"[CONFIG] MCP server config template: $mcpConfigDir\\mcporter.json\"\n\n        # === ACTIVE SETUP: First-Login Configuration Hydration ===\n        Write-Host \"=== Registering Active Setup for first-login hydration ===\"\n\n        # Hydration script OVERWRITES existing config to ensure consistency\n        $hydrationScript = @'\n$openclawDir = \"$env:USERPROFILE\\.openclaw\"\n$configFile = \"$openclawDir\\openclaw.json\"\n$templateFile = \"C:\\ProgramData\\OpenClaw\\template-config.json\"\n\nif (Test-Path $templateFile) {\n    New-Item -ItemType Directory -Path $openclawDir -Force | Out-Null\n    $workspaceDir = \"$env:USERPROFILE\\Documents\\OpenClawWorkspace\"\n    New-Item -ItemType Directory -Path $workspaceDir -Force | Out-Null\n    Copy-Item -Path $templateFile -Destination $configFile -Force\n}\n\n# Hydrate curated agent skills\n$skillsSource = \"C:\\ProgramData\\OpenClaw\\skills\"\n$skillsDest = \"$env:USERPROFILE\\.agents\\skills\"\nif (Test-Path $skillsSource) {\n    New-Item -ItemType Directory -Path $skillsDest -Force | Out-Null\n    Copy-Item -Path \"$skillsSource\\*\" -Destination $skillsDest -Recurse -Force\n}\n\n# Hydrate MCP server configuration\n$mcpSource = \"C:\\ProgramData\\OpenClaw\\mcp\\mcporter.json\"\n$mcpDest = \"$openclawDir\\workspace\\config\"\nif (Test-Path $mcpSource) {\n    New-Item -ItemType Directory -Path $mcpDest -Force | Out-Null\n    Copy-Item -Path $mcpSource -Destination \"$mcpDest\\mcporter.json\" -Force\n}\n'@\n\n        $hydrationScriptPath = \"$openclawTemplateDir\\hydrate-config.ps1\"\n        Set-Content -Path $hydrationScriptPath -Value $hydrationScript -Encoding UTF8\n\n        # Register via Active Setup\n        $activeSetupKey = \"HKLM:\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\OpenClaw-ConfigHydration\"\n        New-Item -Path $activeSetupKey -Force | Out-Null\n        Set-ItemProperty -Path $activeSetupKey -Name \"(Default)\" -Value \"OpenClaw Configuration Hydration\"\n        Set-ItemProperty -Path $activeSetupKey -Name \"StubPath\" -Value \"powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File `\"$hydrationScriptPath`\"\"\n        Set-ItemProperty -Path $activeSetupKey -Name \"Version\" -Value \"1,0,0,0\"\n        Write-Host \"[CONFIG] Active Setup registered: OpenClaw-ConfigHydration\"\n\n        # === TEAMS OPTIMISATION PREREQUISITES ===\n        Write-Host \"=== Setting Teams optimisation prerequisites ===\"\n        $teamsRegPath = \"HKLM:\\SOFTWARE\\Microsoft\\Teams\"\n        if (-not (Test-Path $teamsRegPath)) {\n            New-Item -Path $teamsRegPath -Force | Out-Null\n        }\n        Set-ItemProperty -Path $teamsRegPath -Name \"IsWVDEnvironment\" -Value 1 -Type DWord -Force\n        Write-Host \"[CONFIG] Teams IsWVDEnvironment = 1\"\n\n        # === IMAGE CLEANUP \u0026 OPTIMISATION ===\n        Write-Host \"=== Cleaning up image ===\"\n        Remove-Item -Path \"$env:TEMP\\*\" -Recurse -Force -ErrorAction SilentlyContinue\n        Stop-Service -Name wuauserv -Force -ErrorAction SilentlyContinue\n        Remove-Item -Path \"C:\\Windows\\SoftwareDistribution\\Download\\*\" -Recurse -Force -ErrorAction SilentlyContinue\n        Start-Service -Name wuauserv -ErrorAction SilentlyContinue\n        npm cache clean --force 2\u003e\u00261 | Out-Null\n\n        Write-Host \"[CLEANUP] Running DISM component store cleanup...\"\n        Start-Process -FilePath \"dism.exe\" `\n            -ArgumentList \"/Online /Cleanup-Image /StartComponentCleanup /ResetBase\" `\n            -Wait -NoNewWindow\n\n        Write-Host \"=== Phase 4 Complete: Configuration and cleanup done ===\"\n"
                      ],
                      "name": "ConfigureAgents",
                      "runAsSystem": true,
                      "runElevated": true,
                      "type": "PowerShell"
                    },
                    {
                      "filters": [
                        "exclude:$_.Title -like '*Preview*'",
                        "include:$true"
                      ],
                      "searchCriteria": "IsInstalled=0",
                      "type": "WindowsUpdate",
                      "updateLimit": 40
                    },
                    {
                      "restartTimeout": "10m",
                      "type": "WindowsRestart"
                    }
                  ],
                  "distribute": [
                    {
                      "excludeFromLatest": true,
                      "galleryImageId": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.Compute/galleries/acgW365Dev/images/W365-W11-25H2-ENU",
                      "runOutputName": "w365-dev-ai-1.0.2",
                      "targetRegions": [
                        {
                          "name": "eastus2",
                          "replicaCount": 1,
                          "storageAccountType": "Standard_LRS"
                        }
                      ],
                      "type": "SharedImage",
                      "versioning": {
                        "major": 1,
                        "scheme": "Latest"
                      }
                    }
                  ],
                  "source": {
                    "offer": "windows-11",
                    "publisher": "MicrosoftWindowsDesktop",
                    "sku": "win11-25h2-ent",
                    "type": "PlatformImage",
                    "version": "26200.7840.260206"
                  },
                  "vmProfile": {
                    "osDiskSizeGB": 128,
                    "vmSize": "Standard_D4s_v5"
                  }
                }
              },
              "type": [
                "object",
                {
                  "properties": [
                    "object",
                    {
                      "buildTimeoutInMinutes": "number",
                      "customize": [
                        "tuple",
                        [
                          [
                            "object",
                            {
                              "inline": [
                                "tuple",
                                [
                                  "string"
                                ]
                              ],
                              "name": "string",
                              "runAsSystem": "bool",
                              "runElevated": "bool",
                              "type": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "restartCheckCommand": "string",
                              "restartCommand": "string",
                              "restartTimeout": "string",
                              "type": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "inline": [
                                "tuple",
                                [
                                  "string"
                                ]
                              ],
                              "name": "string",
                              "runAsSystem": "bool",
                              "runElevated": "bool",
                              "type": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "inline": [
                                "tuple",
                                [
                                  "string"
                                ]
                              ],
                              "name": "string",
                              "runAsSystem": "bool",
                              "runElevated": "bool",
                              "type": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "inline": [
                                "tuple",
                                [
                                  "string"
                                ]
                              ],
                              "name": "string",
                              "runAsSystem": "bool",
                              "runElevated": "bool",
                              "type": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "filters": [
                                "tuple",
                                [
                                  "string",
                                  "string"
                                ]
                              ],
                              "searchCriteria": "string",
                              "type": "string",
                              "updateLimit": "number"
                            }
                          ],
                          [
                            "object",
                            {
                              "restartTimeout": "string",
                              "type": "string"
                            }
                          ]
                        ]
                      ],
                      "distribute": [
                        "tuple",
                        [
                          [
                            "object",
                            {
                              "excludeFromLatest": "bool",
                              "galleryImageId": "string",
                              "runOutputName": "string",
                              "targetRegions": [
                                "tuple",
                                [
                                  [
                                    "object",
                                    {
                                      "name": "string",
                                      "replicaCount": "number",
                                      "storageAccountType": "string"
                                    }
                                  ]
                                ]
                              ],
                              "type": "string",
                              "versioning": [
                                "object",
                                {
                                  "major": "number",
                                  "scheme": "string"
                                }
                              ]
                            }
                          ]
                        ]
                      ],
                      "source": [
                        "object",
                        {
                          "offer": "string",
                          "publisher": "string",
                          "sku": "string",
                          "type": "string",
                          "version": "string"
                        }
                      ],
                      "vmProfile": [
                        "object",
                        {
                          "osDiskSizeGB": "number",
                          "vmSize": "string"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            "create_headers": null,
            "create_query_parameters": null,
            "delete_headers": null,
            "delete_query_parameters": null,
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.VirtualMachineImages/imageTemplates/aib-w365-dev-ai-1-0-2",
            "identity": [
              {
                "identity_ids": [
                  "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.ManagedIdentity/userAssignedIdentities/id-aib-w365-dev"
                ],
                "principal_id": "",
                "tenant_id": "",
                "type": "UserAssigned"
              }
            ],
            "ignore_casing": false,
            "ignore_missing_property": true,
            "ignore_null_property": false,
            "location": "eastus2",
            "locks": null,
            "name": "aib-w365-dev-ai-1-0-2",
            "output": {
              "value": {
                "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourcegroups/rg-w365-images/providers/Microsoft.VirtualMachineImages/imageTemplates/aib-w365-dev-ai-1-0-2",
                "identity": {
                  "userAssignedIdentities": {
                    "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.ManagedIdentity/userAssignedIdentities/id-aib-w365-dev": {
                      "clientId": "9e46c2d2-a830-41f3-940d-fbaf1efec158",
                      "principalId": "8e8bff56-b7ab-4d1d-a6fb-4d82ed2983fa"
                    }
                  }
                },
                "properties": {
                  "customize": [
                    {
                      "inline": [
                        "$ErrorActionPreference = \"Stop\"\n$ProgressPreference = \"SilentlyContinue\"\n\nfunction Update-SessionEnvironment {\n    $machinePath = [Environment]::GetEnvironmentVariable(\"Path\", \"Machine\")\n    $userPath = [Environment]::GetEnvironmentVariable(\"Path\", \"User\")\n    $env:Path = \"$machinePath;$userPath\"\n    Write-Host \"[PATH] Session environment refreshed\"\n}\n\nfunction Get-InstallerWithRetry {\n    param([string]$Uri, [string]$OutFile, [int]$MaxRetries = 3)\n    for ($i = 1; $i -le $MaxRetries; $i++) {\n        try {\n            Write-Host \"[DOWNLOAD] Attempt $i of $MaxRetries : $Uri\"\n            Invoke-WebRequest -Uri $Uri -OutFile $OutFile -UseBasicParsing\n            return\n        } catch {\n            if ($i -eq $MaxRetries) { throw }\n            Write-Host \"[DOWNLOAD] Attempt $i failed, retrying in 10 seconds...\"\n            Start-Sleep -Seconds 10\n        }\n    }\n}\n\nfunction Test-InstallerHash {\n    param([string]$FilePath, [string]$ExpectedHash)\n    if ([string]::IsNullOrWhiteSpace($ExpectedHash)) {\n        Write-Host \"[INTEGRITY] No SHA256 provided for $(Split-Path $FilePath -Leaf) - skipping verification\"\n        return\n    }\n    $actual = (Get-FileHash -Path $FilePath -Algorithm SHA256).Hash\n    if ($actual -ne $ExpectedHash.ToUpper()) {\n        Write-Error \"[INTEGRITY] SHA256 MISMATCH for $(Split-Path $FilePath -Leaf)! Expected: $ExpectedHash Got: $actual\"\n        exit 1\n    }\n    Write-Host \"[INTEGRITY] SHA256 verified for $(Split-Path $FilePath -Leaf)\"\n}\n\n# === NODE.JS ===\n$NodeVersion = \"v24.13.1\"\n$NodeMsiUrl = \"https://nodejs.org/dist/$NodeVersion/node-$NodeVersion-x64.msi\"\n$NodeInstaller = \"$env:TEMP\\node-$NodeVersion-x64.msi\"\n\nWrite-Host \"=== Installing Node.js $NodeVersion ===\"\nGet-InstallerWithRetry -Uri $NodeMsiUrl -OutFile $NodeInstaller\nTest-InstallerHash -FilePath $NodeInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath \"msiexec.exe\" `\n    -ArgumentList \"/i `\"$NodeInstaller`\" /qn /norestart ALLUSERS=1 ADDLOCAL=ALL\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"Node.js installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] Node.js: $(node --version)\"\nWrite-Host \"[VERIFY] npm: $(npm --version)\"\n\n# === PYTHON ===\n$PythonVersion = \"3.14.3\"\n$PythonUrl = \"https://www.python.org/ftp/python/$PythonVersion/python-$PythonVersion-amd64.exe\"\n$PythonInstaller = \"$env:TEMP\\python-$PythonVersion-amd64.exe\"\n\nWrite-Host \"=== Installing Python $PythonVersion ===\"\nGet-InstallerWithRetry -Uri $PythonUrl -OutFile $PythonInstaller\nTest-InstallerHash -FilePath $PythonInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath $PythonInstaller `\n    -ArgumentList \"/quiet InstallAllUsers=1 PrependPath=1 Include_pip=1 Include_test=0 Include_launcher=1\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"Python installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] Python: $(python --version)\"\npython -m pip install --upgrade pip --quiet\nWrite-Host \"[VERIFY] pip: $(python -m pip --version)\"\n\n# === POWERSHELL 7 ===\nWrite-Host \"=== Installing PowerShell 7 ===\"\n$PwshVersion = \"7.4.13\"\n$PwshUrl = \"https://github.com/PowerShell/PowerShell/releases/download/v$PwshVersion/PowerShell-$PwshVersion-win-x64.msi\"\n$PwshInstaller = \"$env:TEMP\\PowerShell-7-x64.msi\"\nGet-InstallerWithRetry -Uri $PwshUrl -OutFile $PwshInstaller\nTest-InstallerHash -FilePath $PwshInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath \"msiexec.exe\" `\n    -ArgumentList \"/i `\"$PwshInstaller`\" /qn /norestart ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=1 ADD_FILE_CONTEXT_MENU_RUNPOWERSHELL=1 ENABLE_PSREMOTING=0 REGISTER_MANIFEST=1 USE_MU=0 ENABLE_MU=0 ADD_PATH=1\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"PowerShell 7 installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] PowerShell 7 installed\"\n\n# === CLEANUP ===\nRemove-Item -Path $NodeInstaller, $PythonInstaller, $PwshInstaller -Force -ErrorAction SilentlyContinue\nWrite-Host \"=== Phase 1 Complete: Runtimes installed ===\"\n"
                      ],
                      "name": "InstallCoreRuntimes"
                    },
                    {
                      "name": ""
                    },
                    {
                      "inline": [
                        "$ErrorActionPreference = \"Stop\"\n$ProgressPreference = \"SilentlyContinue\"\n\nfunction Update-SessionEnvironment {\n    $machinePath = [Environment]::GetEnvironmentVariable(\"Path\", \"Machine\")\n    $userPath = [Environment]::GetEnvironmentVariable(\"Path\", \"User\")\n    $env:Path = \"$machinePath;$userPath\"\n}\n\nfunction Get-InstallerWithRetry {\n    param([string]$Uri, [string]$OutFile, [int]$MaxRetries = 3)\n    for ($i = 1; $i -le $MaxRetries; $i++) {\n        try { Invoke-WebRequest -Uri $Uri -OutFile $OutFile -UseBasicParsing; return }\n        catch { if ($i -eq $MaxRetries) { throw }; Start-Sleep -Seconds 10 }\n    }\n}\n\nfunction Test-InstallerHash {\n    param([string]$FilePath, [string]$ExpectedHash)\n    if ([string]::IsNullOrWhiteSpace($ExpectedHash)) {\n        Write-Host \"[INTEGRITY] No SHA256 provided for $(Split-Path $FilePath -Leaf) - skipping verification\"\n        return\n    }\n    $actual = (Get-FileHash -Path $FilePath -Algorithm SHA256).Hash\n    if ($actual -ne $ExpectedHash.ToUpper()) {\n        Write-Error \"[INTEGRITY] SHA256 MISMATCH for $(Split-Path $FilePath -Leaf)! Expected: $ExpectedHash Got: $actual\"\n        exit 1\n    }\n    Write-Host \"[INTEGRITY] SHA256 verified for $(Split-Path $FilePath -Leaf)\"\n}\n\n# === VISUAL STUDIO CODE ===\nWrite-Host \"=== Installing Visual Studio Code (System) ===\"\n$VSCodeUrl = \"https://update.code.visualstudio.com/latest/win32-x64/stable\"\n$VSCodeInstaller = \"$env:TEMP\\VSCodeSetup-x64.exe\"\nGet-InstallerWithRetry -Uri $VSCodeUrl -OutFile $VSCodeInstaller\n\n$proc = Start-Process -FilePath $VSCodeInstaller `\n    -ArgumentList \"/VERYSILENT /NORESTART /MERGETASKS=`\"!runcode,addcontextmenufiles,addcontextmenufolders,addtopath`\"\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"VS Code installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] VS Code installed to: C:\\Program Files\\Microsoft VS Code\"\n\n# === GIT FOR WINDOWS ===\nWrite-Host \"=== Installing Git for Windows ===\"\n$GitVersion = \"2.53.0\"\n$GitUrl = \"https://github.com/git-for-windows/git/releases/download/v${GitVersion}.windows.1/Git-${GitVersion}-64-bit.exe\"\n$GitInstaller = \"$env:TEMP\\Git-${GitVersion}-64-bit.exe\"\nGet-InstallerWithRetry -Uri $GitUrl -OutFile $GitInstaller\nTest-InstallerHash -FilePath $GitInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath $GitInstaller `\n    -ArgumentList \"/VERYSILENT /NORESTART /PathOption=Cmd /NoAutoCrlf /SetupType=default\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"Git installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] Git: $(git --version)\"\n\n# === GITHUB DESKTOP ===\nWrite-Host \"=== Installing GitHub Desktop (Machine-Wide Provisioner) ===\"\n$GHDesktopUrl = \"https://central.github.com/deployments/desktop/desktop/latest/GitHubDesktopSetup-x64.msi\"\n$GHDesktopInstaller = \"$env:TEMP\\GitHubDesktop-x64.msi\"\nGet-InstallerWithRetry -Uri $GHDesktopUrl -OutFile $GHDesktopInstaller\n\n$proc = Start-Process -FilePath \"msiexec.exe\" `\n    -ArgumentList \"/i `\"$GHDesktopInstaller`\" /qn /norestart ALLUSERS=1\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"GitHub Desktop installation failed ($($proc.ExitCode))\"; exit 1 }\nWrite-Host \"[VERIFY] GitHub Desktop provisioner installed\"\n\n# === AZURE CLI ===\n$AzCliVersion = \"2.83.0\"\nWrite-Host \"=== Installing Azure CLI $AzCliVersion ===\"\n$AzCliUrl = \"https://azcliprod.blob.core.windows.net/msi/azure-cli-$AzCliVersion-x64.msi\"\n$AzCliInstaller = \"$env:TEMP\\azure-cli-$AzCliVersion-x64.msi\"\nGet-InstallerWithRetry -Uri $AzCliUrl -OutFile $AzCliInstaller\nTest-InstallerHash -FilePath $AzCliInstaller -ExpectedHash \"\"\n\n$proc = Start-Process -FilePath \"msiexec.exe\" `\n    -ArgumentList \"/i `\"$AzCliInstaller`\" /qn /norestart ALLUSERS=1\" `\n    -Wait -PassThru\nif ($proc.ExitCode -ne 0) { Write-Error \"Azure CLI installation failed ($($proc.ExitCode))\"; exit 1 }\nUpdate-SessionEnvironment\nWrite-Host \"[VERIFY] Azure CLI: $(az --version 2\u003e\u00261 | Select-Object -First 1)\"\n\n# === GITHUB COPILOT (VS Code Extension) ===\nWrite-Host \"=== Installing GitHub Copilot VS Code Extension ===\"\n$codeBin = \"C:\\Program Files\\Microsoft VS Code\\bin\\code.cmd\"\nif (Test-Path $codeBin) {\n    \u0026 $codeBin --install-extension GitHub.copilot --force 2\u003e\u00261 | Write-Host\n    \u0026 $codeBin --install-extension GitHub.copilot-chat --force 2\u003e\u00261 | Write-Host\n    Write-Host \"[VERIFY] GitHub Copilot extensions installed\"\n} else {\n    Write-Error \"VS Code not found at expected path - cannot install Copilot extension\"\n    exit 1\n}\n\n# === CLEANUP ===\nRemove-Item -Path $VSCodeInstaller, $GitInstaller, $GHDesktopInstaller, $AzCliInstaller -Force -ErrorAction SilentlyContinue\nWrite-Host \"=== Phase 2 Complete: Developer tools installed ===\"\n"
                      ],
                      "name": "InstallDevTools"
                    },
                    {
                      "inline": [
                        "$ErrorActionPreference = \"Stop\"\n$ProgressPreference = \"SilentlyContinue\"\n\nfunction Update-SessionEnvironment {\n    $machinePath = [Environment]::GetEnvironmentVariable(\"Path\", \"Machine\")\n    $userPath = [Environment]::GetEnvironmentVariable(\"Path\", \"User\")\n    $env:Path = \"$machinePath;$userPath\"\n}\n\nUpdate-SessionEnvironment\n\n# Verify prerequisites\n$nodeCheck = Get-Command node -ErrorAction SilentlyContinue\n$npmCheck = Get-Command npm -ErrorAction SilentlyContinue\nif (-not $nodeCheck -or -not $npmCheck) {\n    Write-Error \"Node.js or npm not found in PATH. Phase 1 may have failed.\"\n    exit 1\n}\nWrite-Host \"[PREREQ] Node.js: $(node --version)\"\nWrite-Host \"[PREREQ] npm: $(npm --version)\"\n\n# === OPENSPEC ===\nWrite-Host \"=== Installing OpenSpec 0.9.1 (global) ===\"\nnpm install -g @fission-ai/openspec@0.9.1 2\u003e\u00261 | Write-Host\nif ($LASTEXITCODE -ne 0) { Write-Error \"OpenSpec npm install failed ($LASTEXITCODE)\"; exit 1 }\nUpdate-SessionEnvironment\n\n$openspecCheck = Get-Command openspec -ErrorAction SilentlyContinue\nif (-not $openspecCheck) { Write-Error \"openspec not found in PATH after installation\"; exit 1 }\nWrite-Host \"[VERIFY] OpenSpec: $(openspec --version 2\u003e\u00261)\"\n\n# === MCP SERVER PACKAGES ===\n$mcpPackages = @(\"@perplexity-ai/mcp-server\")\nif ($mcpPackages.Count -gt 0) {\n    Write-Host \"=== Installing MCP server packages ===\"\n    foreach ($pkg in $mcpPackages) {\n        Write-Host \"  Installing: $pkg\"\n        npm install -g $pkg 2\u003e\u00261 | Write-Host\n        if ($LASTEXITCODE -ne 0) {\n            Write-Warning \"MCP package install failed for $pkg (non-fatal)\"\n        }\n    }\n    Write-Host \"[VERIFY] MCP server packages installed: $($mcpPackages.Count)\"\n} else {\n    Write-Host \"[SKIP] No MCP server packages configured\"\n}\n\n# === NPM GLOBAL PACKAGE INVENTORY ===\nWrite-Host \"=== Listing global npm packages ===\"\nnpm list -g --depth=0 2\u003e\u00261 | Write-Host\nWrite-Host \"[SECURITY] Global package inventory logged (npm audit does not support --global)\"\n\n# === SBOM GENERATION ===\nWrite-Host \"=== Generating Software Bill of Materials (SBOM) ===\"\n$sbomDir = \"C:\\ProgramData\\ImageBuild\"\nNew-Item -ItemType Directory -Path $sbomDir -Force | Out-Null\n\n$globalPackages = npm list -g --json 2\u003e$null\nSet-Content -Path \"$sbomDir\\sbom-npm-global.json\" -Value $globalPackages -Encoding UTF8\nWrite-Host \"[SBOM] npm global packages: $sbomDir\\sbom-npm-global.json\"\n\n# Record installed software versions\n$softwareManifest = @{\n    buildDate       = (Get-Date -Format \"yyyy-MM-dd'T'HH:mm:ss'Z'\")\n    nodeVersion     = (node --version 2\u003e\u00261).ToString()\n    npmVersion      = (npm --version 2\u003e\u00261).ToString()\n    pythonVersion   = (python --version 2\u003e\u00261).ToString()\n    gitVersion      = (git --version 2\u003e\u00261).ToString()\n    pwshVersion     = (pwsh --version 2\u003e\u00261).ToString()\n    azCliVersion    = (az --version 2\u003e\u00261 | Select-Object -First 1).ToString()\n    openspecVersion = (openspec --version 2\u003e\u00261).ToString()\n} | ConvertTo-Json -Depth 3\nSet-Content -Path \"$sbomDir\\sbom-software-manifest.json\" -Value $softwareManifest -Encoding UTF8\nWrite-Host \"[SBOM] Software manifest: $sbomDir\\sbom-software-manifest.json\"\n\nWrite-Host \"=== Phase 3 Complete: AI tooling installed ===\"\n"
                      ],
                      "name": "InstallAIAgents"
                    },
                    {
                      "inline": [
                        "        $ErrorActionPreference = \"Stop\"\n\n        # === CLAUDE CODE: Enterprise Managed Settings ===\n        Write-Host \"=== Configuring Claude Code enterprise policy ===\"\n        $claudeConfigDir = \"C:\\ProgramData\\ClaudeCode\"\n        New-Item -ItemType Directory -Path $claudeConfigDir -Force | Out-Null\n\n        $managedSettings = @{\n            autoUpdatesChannel = \"stable\"\n            permissions = @{\n                defaultMode = \"allowWithPermission\"\n            }\n        } | ConvertTo-Json -Depth 5\n\n        $managedSettingsPath = \"$claudeConfigDir\\managed-settings.json\"\n        Set-Content -Path $managedSettingsPath -Value $managedSettings -Encoding UTF8\n        Write-Host \"[CONFIG] Claude Code managed settings: $managedSettingsPath\"\n\n        # === OPENCLAW: Configuration Template ===\n        Write-Host \"=== Creating OpenClaw configuration template ===\"\n        $openclawTemplateDir = \"C:\\ProgramData\\OpenClaw\"\n        New-Item -ItemType Directory -Path $openclawTemplateDir -Force | Out-Null\n\n        $openclawConfig = @{\n            agent = @{\n                model = \"anthropic/claude-opus-4-6\"\n                defaults = @{\n                    workspace = \"~/Documents/OpenClawWorkspace\"\n                }\n            }\n            gateway = @{\n                mode = \"local\"\n                port = 18789\n            }\n            channels = @{\n                web = @{ enabled = $true }\n            }\n        } | ConvertTo-Json -Depth 5\n\n        $templatePath = \"$openclawTemplateDir\\template-config.json\"\n        Set-Content -Path $templatePath -Value $openclawConfig -Encoding UTF8\n        Write-Host \"[CONFIG] OpenClaw template: $templatePath\"\n\n        # === CURATED AGENT SKILLS ===\n        $skillsRepoUrl = \"\"\n        $skillsDir = \"C:\\ProgramData\\OpenClaw\\skills\"\n        if ($skillsRepoUrl -ne \"\") {\n            Write-Host \"=== Cloning curated agent skills ===\"\n            New-Item -ItemType Directory -Path $skillsDir -Force | Out-Null\n            git clone --depth 1 $skillsRepoUrl \"$skillsDir\\approved\" 2\u003e\u00261 | Write-Host\n            if ($LASTEXITCODE -ne 0) {\n                Write-Warning \"Skills clone failed - skills will need to be installed post-provisioning\"\n            } else {\n                $skillCount = (Get-ChildItem -Path \"$skillsDir\\approved\" -Filter \"SKILL.md\" -Recurse).Count\n                Write-Host \"[CONFIG] Curated skills cloned: $skillCount skills found\"\n            }\n        } else {\n            Write-Host \"[SKIP] No skills repository configured\"\n        }\n\n        # === MCP SERVER CONFIGURATION TEMPLATE ===\n        Write-Host \"=== Creating MCP server configuration template ===\"\n        $mcpConfigDir = \"C:\\ProgramData\\OpenClaw\\mcp\"\n        New-Item -ItemType Directory -Path $mcpConfigDir -Force | Out-Null\n\n        # Template with placeholder API keys - real keys delivered via Intune env vars\n        $mcpConfig = @{\n            servers = @{\n                \"microsoft-docs\" = @{\n                    transport = \"http\"\n                    url       = \"https://learn.microsoft.com/api/mcp\"\n                }\n                \"perplexity\" = @{\n                    transport = \"stdio\"\n                    command   = \"npx\"\n                    args      = @(\"-y\", \"@perplexity-ai/mcp-server\")\n                    env       = @{\n                        PERPLEXITY_API_KEY = \"__PERPLEXITY_API_KEY__\"\n                    }\n                }\n            }\n        } | ConvertTo-Json -Depth 5\n\n        Set-Content -Path \"$mcpConfigDir\\mcporter.json\" -Value $mcpConfig -Encoding UTF8\n        Write-Host \"[CONFIG] MCP server config template: $mcpConfigDir\\mcporter.json\"\n\n        # === ACTIVE SETUP: First-Login Configuration Hydration ===\n        Write-Host \"=== Registering Active Setup for first-login hydration ===\"\n\n        # Hydration script OVERWRITES existing config to ensure consistency\n        $hydrationScript = @'\n$openclawDir = \"$env:USERPROFILE\\.openclaw\"\n$configFile = \"$openclawDir\\openclaw.json\"\n$templateFile = \"C:\\ProgramData\\OpenClaw\\template-config.json\"\n\nif (Test-Path $templateFile) {\n    New-Item -ItemType Directory -Path $openclawDir -Force | Out-Null\n    $workspaceDir = \"$env:USERPROFILE\\Documents\\OpenClawWorkspace\"\n    New-Item -ItemType Directory -Path $workspaceDir -Force | Out-Null\n    Copy-Item -Path $templateFile -Destination $configFile -Force\n}\n\n# Hydrate curated agent skills\n$skillsSource = \"C:\\ProgramData\\OpenClaw\\skills\"\n$skillsDest = \"$env:USERPROFILE\\.agents\\skills\"\nif (Test-Path $skillsSource) {\n    New-Item -ItemType Directory -Path $skillsDest -Force | Out-Null\n    Copy-Item -Path \"$skillsSource\\*\" -Destination $skillsDest -Recurse -Force\n}\n\n# Hydrate MCP server configuration\n$mcpSource = \"C:\\ProgramData\\OpenClaw\\mcp\\mcporter.json\"\n$mcpDest = \"$openclawDir\\workspace\\config\"\nif (Test-Path $mcpSource) {\n    New-Item -ItemType Directory -Path $mcpDest -Force | Out-Null\n    Copy-Item -Path $mcpSource -Destination \"$mcpDest\\mcporter.json\" -Force\n}\n'@\n\n        $hydrationScriptPath = \"$openclawTemplateDir\\hydrate-config.ps1\"\n        Set-Content -Path $hydrationScriptPath -Value $hydrationScript -Encoding UTF8\n\n        # Register via Active Setup\n        $activeSetupKey = \"HKLM:\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\OpenClaw-ConfigHydration\"\n        New-Item -Path $activeSetupKey -Force | Out-Null\n        Set-ItemProperty -Path $activeSetupKey -Name \"(Default)\" -Value \"OpenClaw Configuration Hydration\"\n        Set-ItemProperty -Path $activeSetupKey -Name \"StubPath\" -Value \"powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File `\"$hydrationScriptPath`\"\"\n        Set-ItemProperty -Path $activeSetupKey -Name \"Version\" -Value \"1,0,0,0\"\n        Write-Host \"[CONFIG] Active Setup registered: OpenClaw-ConfigHydration\"\n\n        # === TEAMS OPTIMISATION PREREQUISITES ===\n        Write-Host \"=== Setting Teams optimisation prerequisites ===\"\n        $teamsRegPath = \"HKLM:\\SOFTWARE\\Microsoft\\Teams\"\n        if (-not (Test-Path $teamsRegPath)) {\n            New-Item -Path $teamsRegPath -Force | Out-Null\n        }\n        Set-ItemProperty -Path $teamsRegPath -Name \"IsWVDEnvironment\" -Value 1 -Type DWord -Force\n        Write-Host \"[CONFIG] Teams IsWVDEnvironment = 1\"\n\n        # === IMAGE CLEANUP \u0026 OPTIMISATION ===\n        Write-Host \"=== Cleaning up image ===\"\n        Remove-Item -Path \"$env:TEMP\\*\" -Recurse -Force -ErrorAction SilentlyContinue\n        Stop-Service -Name wuauserv -Force -ErrorAction SilentlyContinue\n        Remove-Item -Path \"C:\\Windows\\SoftwareDistribution\\Download\\*\" -Recurse -Force -ErrorAction SilentlyContinue\n        Start-Service -Name wuauserv -ErrorAction SilentlyContinue\n        npm cache clean --force 2\u003e\u00261 | Out-Null\n\n        Write-Host \"[CLEANUP] Running DISM component store cleanup...\"\n        Start-Process -FilePath \"dism.exe\" `\n            -ArgumentList \"/Online /Cleanup-Image /StartComponentCleanup /ResetBase\" `\n            -Wait -NoNewWindow\n\n        Write-Host \"=== Phase 4 Complete: Configuration and cleanup done ===\"\n"
                      ],
                      "name": "ConfigureAgents"
                    },
                    {
                      "filters": [
                        "exclude:$_.Title -like '*Preview*'",
                        "include:$true"
                      ],
                      "name": ""
                    },
                    {
                      "name": ""
                    }
                  ],
                  "distribute": [
                    {
                      "artifactTags": {},
                      "runOutputName": "w365-dev-ai-1.0.2",
                      "targetRegions": [
                        {}
                      ]
                    }
                  ],
                  "exactStagingResourceGroup": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/IT_rg-w365-images_aib-w365-dev-ai-1-0-2_5eeb6087-3ee6-4d0a-9eb8-c94a278ad0ae",
                  "provisioningState": "Succeeded",
                  "source": {
                    "exactVersion": "26200.7840.260206"
                  }
                },
                "tags": {
                  "cost_center": "Engineering",
                  "iac": "Terraform",
                  "managed_by": "PlatformEngineering",
                  "purpose": "DeveloperImages",
                  "workload": "Windows365"
                },
                "type": "Microsoft.VirtualMachineImages/imageTemplates"
              },
              "type": [
                "object",
                {
                  "id": "string",
                  "identity": [
                    "object",
                    {
                      "userAssignedIdentities": [
                        "object",
                        {
                          "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.ManagedIdentity/userAssignedIdentities/id-aib-w365-dev": [
                            "object",
                            {
                              "clientId": "string",
                              "principalId": "string"
                            }
                          ]
                        }
                      ]
                    }
                  ],
                  "properties": [
                    "object",
                    {
                      "customize": [
                        "tuple",
                        [
                          [
                            "object",
                            {
                              "inline": [
                                "tuple",
                                [
                                  "string"
                                ]
                              ],
                              "name": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "name": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "inline": [
                                "tuple",
                                [
                                  "string"
                                ]
                              ],
                              "name": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "inline": [
                                "tuple",
                                [
                                  "string"
                                ]
                              ],
                              "name": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "inline": [
                                "tuple",
                                [
                                  "string"
                                ]
                              ],
                              "name": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "filters": [
                                "tuple",
                                [
                                  "string",
                                  "string"
                                ]
                              ],
                              "name": "string"
                            }
                          ],
                          [
                            "object",
                            {
                              "name": "string"
                            }
                          ]
                        ]
                      ],
                      "distribute": [
                        "tuple",
                        [
                          [
                            "object",
                            {
                              "artifactTags": [
                                "object",
                                {}
                              ],
                              "runOutputName": "string",
                              "targetRegions": [
                                "tuple",
                                [
                                  [
                                    "object",
                                    {}
                                  ]
                                ]
                              ]
                            }
                          ]
                        ]
                      ],
                      "exactStagingResourceGroup": "string",
                      "provisioningState": "string",
                      "source": [
                        "object",
                        {
                          "exactVersion": "string"
                        }
                      ]
                    }
                  ],
                  "tags": [
                    "object",
                    {
                      "cost_center": "string",
                      "iac": "string",
                      "managed_by": "string",
                      "purpose": "string",
                      "workload": "string"
                    }
                  ],
                  "type": "string"
                }
              ]
            },
            "parent_id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images",
            "read_headers": null,
            "read_query_parameters": null,
            "replace_triggers_external_values": null,
            "replace_triggers_refs": null,
            "response_export_values": null,
            "retry": null,
            "schema_validation_enabled": true,
            "sensitive_body": null,
            "sensitive_body_version": null,
            "tags": {
              "cost_center": "Engineering",
              "iac": "Terraform",
              "managed_by": "PlatformEngineering",
              "purpose": "DeveloperImages",
              "workload": "Windows365"
            },
            "timeouts": null,
            "type": "Microsoft.VirtualMachineImages/imageTemplates@2024-02-01",
            "update_headers": null,
            "update_query_parameters": null
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "identity": {
            "id": "/subscriptions/7a713a84-2144-4ea1-8e85-9c63111bd995/resourceGroups/rg-w365-images/providers/Microsoft.VirtualMachineImages/imageTemplates/aib-w365-dev-ai-1-0-2",
            "type": null
          },
          "private": "eyJzZW5zaXRpdmVfYm9keSI6ImV5Sm9ZWE5vSWpvaVpFTk9UMjFMTDI1VFdTc3hNblpJZW1GelRGaHBjM2Q2YkVkVU5WVklRVGRxUVVkWmEzWnRRM1ZSY3owaWZRPT0ifQ==",
          "dependencies": [
            "azurerm_resource_group.images",
            "module.gallery.azurerm_shared_image.this",
            "module.gallery.azurerm_shared_image_gallery.this",
            "module.identity.azurerm_user_assigned_identity.aib"
          ]
        }
      ]
    },
    {
      "module": "module.image_builder",
      "mode": "managed",
      "type": "time_static",
      "name": "build_time",
      "provider": "provider[\"registry.terraform.io/hashicorp/time\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "day": 27,
            "hour": 20,
            "id": "2026-02-27T20:12:39Z",
            "minute": 12,
            "month": 2,
            "rfc3339": "2026-02-27T20:12:39Z",
            "second": 39,
            "triggers": null,
            "unix": 1772223159,
            "year": 2026
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0
        }
      ]
    }
  ],
  "check_results": [
    {
      "object_kind": "var",
      "config_addr": "var.node_version",
      "status": "pass",
      "objects": [
        {
          "object_addr": "var.node_version",
          "status": "pass"
        }
      ]
    },
    {
      "object_kind": "var",
      "config_addr": "var.image_version",
      "status": "pass",
      "objects": [
        {
          "object_addr": "var.image_version",
          "status": "pass"
        }
      ]
    },
    {
      "object_kind": "var",
      "config_addr": "var.gallery_name",
      "status": "pass",
      "objects": [
        {
          "object_addr": "var.gallery_name",
          "status": "pass"
        }
      ]
    },
    {
      "object_kind": "var",
      "config_addr": "var.source_image_version",
      "status": "pass",
      "objects": [
        {
          "object_addr": "var.source_image_version",
          "status": "pass"
        }
      ]
    }
  ]
}
